name: Build and Release JAR on Push

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: gradle

      - name: Build with Gradle
        run: ./gradlew clean build

      - name: Generate release description
        id: generate_release_desc
        run: |
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          DESCRIPTION="**–ü–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è SCustomEnchantments**, —Å–æ–±—Ä–∞–Ω–Ω–∞—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞.  
          
          **–ö–æ–º–º–∏—Ç:** <$COMMIT_URL>
          
          > [!–í–ù–ò–ú–ê–ù–ò–ï]
          > –≠—Ç–∞ –≤–µ—Ä—Å–∏—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–∞. –û—Ç–ø—Ä–∞–≤–ª—è–π—Ç–µ –≤—Å–µ –±–∞–≥–∏ –≤ [Issues](https://github.com/${{ github.repository }}/issues).
          
          ### –ö–∞–∫ –æ–±–Ω–æ–≤–∏—Ç—å—Å—è:
          1. –°–∫–∞—á–∞–π—Ç–µ `SCustomEnchantments-*.jar` –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ.
          2. –ó–∞–º–µ–Ω–∏—Ç–µ —Ç–µ–∫—É—â–∏–π —Ñ–∞–π–ª `.jar` –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞.
          3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä.
          4. –ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º! üéâ  

          –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –±–∞–≥–∏, –ø–∏—à–∏—Ç–µ –≤ [Issues](https://github.com/${{ github.repository }}/issues)."

          echo "RELEASE_DESC<<EOF" >> $GITHUB_ENV
          echo "$DESCRIPTION" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Find built JAR
        id: find_jar
        run: |
          JAR_PATH=$(find ./build/libs -name "*.jar" ! -name "*-sources.jar" ! -name "*-javadoc.jar" | head -n 1)
          echo "JAR_PATH=$JAR_PATH" >> $GITHUB_OUTPUT
          echo "JAR_NAME=$(basename $JAR_PATH)" >> $GITHUB_OUTPUT

      - name: Release latest build
        uses: Xotl/cool-github-releases@v1.1.9
        if: success() && github.repository == 'SocialMoods/SCustomEnchantments'
        with:
          mode: update
          isPrerelease: true
          tag_name: snapshot
          release_name: "Latest Snapshot"
          body_mrkdwn: ${{ env.RELEASE_DESC }}
          assets: ${{ steps.find_jar.outputs.JAR_PATH }}|application/java-archive
          replace_assets: true
          github_token: ${{ secrets.GH_TOKEN }}
